<!doctype html>
<html lang="es">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Riqueza en Acción — Extractos o Manual</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:#f8fafc;margin:0}
  .wrap{max-width:960px;margin:32px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin:12px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  input,select,button{padding:10px;border:1px solid #e5e7eb;border-radius:12px;font-size:14px}
  button{background:#111827;color:#fff;cursor:pointer}
  pre{background:#0b1020;color:#e5e7eb;padding:12px;border-radius:12px;overflow:auto}
  .msg{font-size:13px;margin-top:6px}
  .ok{color:#059669}.bad{color:#dc2626}
</style>
<body>
<div class="wrap">
  <h1>Riqueza en Acción — Subir extracto o ingresar manual</h1>
  <p>1) Pega la URL de tu API (ngrok) · 2) Sube archivo o agrega movimientos · 3) Métricas y reporte</p>

  <div class="card">
    <h3>1) Conexión con tu API</h3>
    <div class="row">
      <input id="api" style="flex:1" placeholder="https://xxxx.ngrok-free.app"/>
      <button onclick="setAPI()">Guardar</button>
      <button onclick="pingAPI()">Probar</button>
    </div>
    <div id="apistatus" class="msg"></div>
  </div>

  <div class="card">
    <h3>2A) Subir extracto (CSV o XLSX)</h3>
    <div class="row">
      <input id="file" type="file" accept=".csv,.xlsx,.xls"/>
      <select id="currency"><option value="COP">COP</option><option value="USD">USD</option></select>
      <button onclick="upload()">Subir</button>
    </div>
    <details>
      <summary>¿No detecta las columnas? Mapea manualmente (opcional)</summary>
      <p>Ejemplo JSON: <code>{"date":"Fecha","description":"Detalle","amount":"Monto","debit":null,"credit":null}</code></p>
      <input id="mapping" placeholder='{"date":"Fecha","description":"Detalle","amount":"Monto"}' style="width:100%"/>
    </details>
    <div id="upmsg" class="msg"></div>
  </div>

  <div class="card">
    <h3>2B) Agregar movimiento manual</h3>
    <div class="row">
      <input id="date" type="date"/>
      <input id="amount" type="number" step="any" placeholder="Monto (neg=gasto, pos=ingreso)"/>
      <input id="cat" placeholder="Categoría" value="Otros"/>
      <select id="jar">
        <option>NEC</option><option>FFA</option><option>EDU</option>
        <option>LTSS</option><option>PLAY</option><option>GIVE</option>
      </select>
      <input id="note" placeholder="Nota"/>
      <button onclick="addTx()">Guardar</button>
    </div>
    <div id="txmsg" class="msg"></div>
  </div>

  <div class="card">
    <h3>3) Métricas semanales</h3>
    <button onclick="loadMetrics()">Ver métricas</button>
    <pre id="metrics"></pre>
    <div id="metricsmsg" class="msg"></div>
  </div>

  <div class="card">
    <h3>4) Reporte semanal (Insights + Micro-acción + Lección)</h3>
    <button onclick="weekly()">Generar</button>
    <pre id="report"></pre>
    <div id="reportmsg" class="msg"></div>
  </div>
</div>

<script>
let API_BASE = localStorage.getItem("API_BASE") || "";

function setAPI(){
  const v = document.getElementById('api').value.trim();
  if(!v.startsWith("https://")){
    document.getElementById('apistatus').innerHTML = "<span class='bad'>Debe empezar por https://</span>";
    return;
  }
  API_BASE = v.replace(/\/+$/,"");
  localStorage.setItem("API_BASE", API_BASE);
  document.getElementById('apistatus').innerHTML = "<span class='ok'>API guardada: "+API_BASE+"</span>";
}
async function pingAPI(){
  const el = document.getElementById('apistatus');
  if(!API_BASE){ el.innerHTML = "<span class='bad'>Pega tu URL de ngrok arriba.</span>"; return; }
  try {
    const r = await fetch(`${API_BASE}/healthz`);
    const j = await r.json();
    el.innerHTML = j && j.ok ? "<span class='ok'>Conexión OK ✅</span>" : "<span class='bad'>No parece tu API.</span>";
  } catch {
    el.innerHTML = "<span class='bad'>No se pudo conectar. ¿Colab está corriendo?</span>";
  }
}

async function safeFetchJSON(url, options, outPreId, msgId){
  const out = document.getElementById(outPreId), msg = document.getElementById(msgId);
  out.textContent = ""; msg.textContent = "";
  if(!API_BASE){ msg.innerHTML = "<span class='bad'>Configura la API primero.</span>"; return null; }
  try {
    const r = await fetch(url, options);
    const text = await r.text();
    try {
      const json = JSON.parse(text); out.textContent = JSON.stringify(json, null, 2); return json;
    } catch { out.textContent = text; msg.innerHTML = "<span class='bad'>⚠️ La respuesta no es JSON. ¿URL de ngrok correcta? ¿Colab activo?</span>"; return null; }
  } catch { msg.innerHTML = "<span class='bad'>Error de conexión.</span>"; return null; }
}

async function upload(){
  const f = document.getElementById('file').files[0];
  if(!f){ document.getElementById('upmsg').innerHTML = "<span class='bad'>Elige un archivo.</span>"; return; }
  const fd = new FormData();
  fd.append('file', f);
  fd.append('currency', document.getElementById('currency').value);
  const mp = document.getElementById('mapping').value.trim();
  if(mp) fd.append('mapping', mp);
  const r = await safeFetchJSON(`${API_BASE}/api/upload/statement`, { method:"POST", body: fd }, "metrics", "upmsg");
  if(r && r.ok) document.getElementById('upmsg').innerHTML = "<span class='ok'>Subido: "+r.inserted+" movimientos.</span>";
}

async function addTx(){
  const body = {
    date: document.getElementById('date').value || new Date().toISOString().slice(0,10),
    amount: Number(document.getElementById('amount').value || 0),
    currency: "COP",
    category: document.getElementById('cat').value || "Otros",
    jar: document.getElementById('jar').value,
    note: document.getElementById('note').value || ""
  };
  const ok = await safeFetchJSON(`${API_BASE}/api/tx`, {method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}, "metrics", "txmsg");
  document.getElementById('txmsg').innerHTML = ok && ok.ok ? "<span class='ok'>Movimiento guardado ✓</span>" : "<span class='bad'>No se pudo guardar.</span>";
}

async function loadMetrics(){ await safeFetchJSON(`${API_BASE}/api/metrics/weekly`, {}, "metrics", "metricsmsg"); }
async function weekly(){ await safeFetchJSON(`${API_BASE}/api/agent/weekly-report`, {method:"POST", headers:{'Content-Type':'application/json'}, body:"{}"}, "report", "reportmsg"); }

// Restaura API guardada
if(API_BASE){ document.getElementById('api').value = API_BASE; document.getElementById('apistatus').innerHTML = "<span class='ok'>API recordada: "+API_BASE+"</span>"; }
</script>
</body>
</html>
