<!doctype html>
<html lang="es">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Riqueza en Acción — Demo</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:#f8fafc;margin:0}
  .wrap{max-width:960px;margin:32px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin:12px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  input,select,button{padding:10px;border:1px solid #e5e7eb;border-radius:12px;font-size:14px}
  button{background:#111827;color:#fff;cursor:pointer}
  pre{background:#0b1020;color:#e5e7eb;padding:12px;border-radius:12px;overflow:auto}
  .msg{font-size:13px;margin-top:6px}
  .ok{color:#059669}.bad{color:#dc2626}
</style>
<body>
<div class="wrap">
  <h1>Riqueza en Acción — Diario + Guía</h1>
  <p>1) Pon la URL de tu API (ngrok) · 2) Agrega movimientos · 3) Ver métricas y reporte</p>

  <div class="card">
    <h3>1) Conexión con tu API (ngrok)</h3>
    <div class="row">
      <input id="api" style="flex:1" placeholder="https://xxxx.ngrok-free.app"/>
      <button onclick="setAPI()">Guardar</button>
      <button onclick="pingAPI()">Probar</button>
    </div>
    <div id="apistatus" class="msg"></div>
  </div>

  <div class="card">
    <h3>2) Agregar movimiento</h3>
    <div class="row">
      <input id="date" type="date"/>
      <input id="amount" type="number" step="any" placeholder="Monto (neg=gasto)"/>
      <input id="cat" placeholder="Categoría" value="Otros"/>
      <select id="jar">
        <option>NEC</option><option>FFA</option><option>EDU</option>
        <option>LTSS</option><option>PLAY</option><option>GIVE</option>
      </select>
      <input id="note" placeholder="Nota"/>
      <button onclick="addTx()">Guardar</button>
    </div>
    <div id="txmsg" class="msg"></div>
  </div>

  <div class="card">
    <h3>3) Métricas semanales</h3>
    <button onclick="loadMetrics()">Ver métricas</button>
    <pre id="metrics"></pre>
    <div id="metricsmsg" class="msg"></div>
  </div>

  <div class="card">
    <h3>4) Reporte semanal (Insights + Micro-acción + Lección)</h3>
    <button onclick="weekly()">Generar</button>
    <pre id="report"></pre>
    <div id="reportmsg" class="msg"></div>
  </div>

  <div class="card">
    <h3>5) Plan educativo (Kiyosaki + Eker)</h3>
    <button onclick="genPlan()">Crear plan 6 semanas</button>
    <pre id="plan"></pre>
    <div id="planmsg" class="msg"></div>
  </div>
</div>

<script>
let API_BASE = localStorage.getItem("API_BASE") || "";

function setAPI(){
  const v = document.getElementById('api').value.trim();
  if(!v.startsWith("https://")){
    document.getElementById('apistatus').innerHTML = "<span class='bad'>Debe empezar por https://</span>";
    return;
  }
  API_BASE = v.replace(/\/+$/,""); // quitar / final
  localStorage.setItem("API_BASE", API_BASE);
  document.getElementById('apistatus').innerHTML = "<span class='ok'>API guardada: "+API_BASE+"</span>";
}

async function pingAPI(){
  if(!API_BASE){
    document.getElementById('apistatus').innerHTML = "<span class='bad'>Pega primero tu URL de ngrok arriba.</span>";
    return;
  }
  try {
    const r = await fetch(`${API_BASE}/`);
    const t = await r.text();
    document.getElementById('apistatus').innerHTML =
      (r.ok && t.includes('"ok": true'))
      ? "<span class='ok'>Conexión OK ✅</span>"
      : "<span class='bad'>La URL respondió, pero no parece tu API. Revisa.</span>";
  } catch {
    document.getElementById('apistatus').innerHTML = "<span class='bad'>No se pudo conectar. ¿Colab está corriendo?</span>";
  }
}

async function safeFetchJSON(url, options, outPreId, msgId){
  const out = document.getElementById(outPreId), msg = document.getElementById(msgId);
  out.textContent = ""; msg.textContent = "";
  if(!API_BASE){ msg.innerHTML = "<span class='bad'>Primero configura la API (arriba).</span>"; return null; }
  try {
    const r = await fetch(url, options);
    const text = await r.text();
    try {
      const json = JSON.parse(text);
      out.textContent = JSON.stringify(json, null, 2);
      return json;
    } catch {
      out.textContent = text;
      msg.innerHTML = "<span class='bad'>⚠️ La respuesta no es JSON. Suele pasar si API_BASE no es tu URL de ngrok o Colab se detuvo.</span>";
      return null;
    }
  } catch {
    msg.innerHTML = "<span class='bad'>Error de conexión. ¿API viva? ¿URL correcta?</span>";
    return null;
  }
}

async function addTx(){
  const body = {
    date: document.getElementById('date').value || new Date().toISOString().slice(0,10),
    amount: Number(document.getElementById('amount').value || 0),
    currency: "COP",
    category: document.getElementById('cat').value || "Otros",
    jar: document.getElementById('jar').value,
    note: document.getElementById('note').value || ""
  };
  const ok = await safeFetchJSON(`${API_BASE}/api/tx`, {
    method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
  }, "metrics", "txmsg");
  document.getElementById('txmsg').innerHTML = ok ? "<span class='ok'>Movimiento guardado ✓</span>"
                                                  : "<span class='bad'>No se pudo guardar.</span>";
}
async function loadMetrics(){
  await safeFetchJSON(`${API_BASE}/api/metrics/weekly`, {}, "metrics", "metricsmsg");
}
async function weekly(){
  await safeFetchJSON(`${API_BASE}/api/agent/weekly-report`, {
    method:"POST", headers:{'Content-Type':'application/json'}, body:"{}"
  }, "report", "reportmsg");
}
async function genPlan(){
  await safeFetchJSON(`${API_BASE}/api/plan`, {
    method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify({level:"basico", weeks:6})
  }, "plan", "planmsg");
}

// Cargar API_BASE guardado (si había)
if(API_BASE){
  document.getElementById('api').value = API_BASE;
  document.getElementById('apistatus').innerHTML = "<span class='ok'>API recordada: "+API_BASE+"</span>";
}
</script>
</body>
</html>
